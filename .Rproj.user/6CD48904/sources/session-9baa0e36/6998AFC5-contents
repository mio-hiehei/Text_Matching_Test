# Matching on Text Replication

# Source: https://github.com/bstewart/textmatching
# (the following are only needed if I am working out of a project)
# setwd("/Users/jrn/desktop")   # Home
# setwd("C:/Users/wmc855/Desktop/Matching_replicated") # Work
load(file="sim.rda")


# Step 1
# Topics are evaluated (basically the stm modeling)
# After the modeling, one needs to pull out the thetas
# per topic per document

# Step 2
# Step 2 is to recalculate the topics as though they were observed
# as treated.  We do this using the refit() function.
refitted <- refit(sim_topics, sim_documents, content_level="1")


# Step 3
#Step 3 is to calculate the projection onto the treatment variable

projection <- project(sim_topics, sim_documents, interactions = FALSE)


# Step 4
#Finally Step 4 is to match using CEM or other matching method of your
#choice
matched <- cem_match(refitted,projection=projection, sim_meta$treat,
                      projection_breaks=2)


# Now the matched data can be analyzed using standard tools from cem
# Evaluation of the matched data
cem::att(matched, simy ~ treat, data=sim_meta)

#We can compare this to the unadjusted difference in means (overestimates)
summary(lm(simy ~ treat, data=sim_meta))

# and the oracle estimator (based on unobserved covariates)
summary(lm(simy ~ treat + confound1 + confound2 + confound3,data=sim_meta))
